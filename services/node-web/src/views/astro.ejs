<!-- Astronomical Events Page -->
<div class="animate__animated animate__fadeIn">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">
      ‚≠ê –ê—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
    </h1>
    <p class="text-gray-400 mt-2">–°–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–±–æ—Å–≤–æ–¥–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç AstronomyAPI</p>
  </div>

  <!-- Controls -->
  <div class="space-card rounded-lg p-6 mb-6 animate__animated animate__fadeInDown">
    <form id="astro-form" class="space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-yellow-400">üéõÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h3>
        <button type="submit" 
                class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors">
          üîç –ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Latitude -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–®–∏—Ä–æ—Ç–∞</label>
          <input type="number" 
                 step="0.0001" 
                 name="lat" 
                 value="55.7558" 
                 class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
                 placeholder="55.7558">
        </div>

        <!-- Longitude -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–î–æ–ª–≥–æ—Ç–∞</label>
          <input type="number" 
                 step="0.0001" 
                 name="lon" 
                 value="37.6176" 
                 class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
                 placeholder="37.6176">
        </div>

        <!-- Days -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–î–Ω–µ–π –≤–ø–µ—Ä—ë–¥</label>
          <input type="number" 
                 min="1" 
                 max="30" 
                 name="days" 
                 value="7" 
                 class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
        </div>

        <!-- Quick Location -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä</label>
          <select id="quick-location" class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
            <option value="55.7558,37.6176">üèõÔ∏è –ú–æ—Å–∫–≤–∞</option>
            <option value="59.9311,30.3609">üè∞ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
            <option value="40.7128,-74.0060">üóΩ –ù—å—é-–ô–æ—Ä–∫</option>
            <option value="51.5074,-0.1278">üé™ –õ–æ–Ω–¥–æ–Ω</option>
            <option value="48.8566,2.3522">üóº –ü–∞—Ä–∏–∂</option>
            <option value="35.6762,139.6503">üèØ –¢–æ–∫–∏–æ</option>
          </select>
        </div>
      </div>
    </form>
  </div>

  <!-- Loading State -->
  <div id="loading" class="text-center py-12 space-card rounded-lg">
    <div class="loading text-yellow-400 text-4xl mb-4">‚≠ê</div>
    <h3 class="text-lg font-semibold text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</h3>
    <p class="text-gray-500 mt-2">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ AstronomyAPI</p>
  </div>

  <!-- Events Table -->
  <div id="events-section" class="space-card rounded-lg p-6 animate__animated animate__fadeInUp" style="display: none;">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold text-yellow-400">üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
      <div class="flex items-center space-x-3">
        <span id="events-count" class="text-sm text-gray-400">0 —Å–æ–±—ã—Ç–∏–π</span>
        <button id="export-events" 
                class="px-4 py-2 bg-orange-600 bg-opacity-20 hover:bg-opacity-30 border border-orange-500 rounded text-orange-400 text-sm transition-all">
          üì• –≠–∫—Å–ø–æ—Ä—Ç CSV
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-600">
            <th class="text-left py-3 px-3 text-gray-400">#</th>
            <th class="text-left py-3 px-3 text-gray-400">–û–±—ä–µ–∫—Ç</th>
            <th class="text-left py-3 px-3 text-gray-400">–°–æ–±—ã—Ç–∏–µ</th>
            <th class="text-left py-3 px-3 text-gray-400">–í—Ä–µ–º—è (UTC)</th>
            <th class="text-left py-3 px-3 text-gray-400">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</th>
          </tr>
        </thead>
        <tbody id="events-table-body">
          <tr><td colspan="5" class="text-center py-4 text-gray-500">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Raw JSON -->
  <div id="raw-section" class="space-card rounded-lg p-6 animate__animated animate__fadeInUp" style="display: none;">
    <details>
      <summary class="cursor-pointer text-gray-400 hover:text-white mb-4">
        üîç –ü–æ–ª–Ω—ã–π JSON –æ—Ç–≤–µ—Ç
      </summary>
      <pre id="raw-json" class="bg-slate-800 rounded-lg p-4 text-xs overflow-auto max-h-96 text-green-400"></pre>
    </details>
  </div>

  <!-- Error State -->
  <div id="error-state" class="text-center py-12 space-card rounded-lg" style="display: none;">
    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
    <h3 class="text-xl font-semibold text-red-400 mb-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
    <p id="error-message" class="text-gray-400 mb-4"></p>
    <button class="px-4 py-2 bg-yellow-600 bg-opacity-20 hover:bg-opacity-30 border border-yellow-500 rounded text-yellow-400 transition-all"
            onclick="loadEvents()">
      üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    </button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('‚≠ê Astro Events Page –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

  // Elements
  const form = document.getElementById('astro-form');
  const quickLocation = document.getElementById('quick-location');
  const loading = document.getElementById('loading');
  const eventsSection = document.getElementById('events-section');
  const rawSection = document.getElementById('raw-section');
  const errorState = document.getElementById('error-state');

  // State
  let currentEvents = [];
  let rawData = null;

  // Quick location selector
  quickLocation.addEventListener('change', () => {
    const value = quickLocation.value;
    if (value) {
      const [lat, lon] = value.split(',');
      form.lat.value = lat;
      form.lon.value = lon;
    }
  });

  // Form submission
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    loadEvents();
  });

  // Load events function
  async function loadEvents() {
    showLoading();
    
    try {
      const formData = new FormData(form);
      const params = new URLSearchParams(formData);
      
      const response = await fetch(`/api/astro/events?${params.toString()}`);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || `HTTP ${response.status}`);
      }
      
      rawData = data;
      processEvents(data);
      showEvents();
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Å—Ç—Ä–æ —Å–æ–±—ã—Ç–∏–π:', error);
      showError(error.message);
    }
  }

  function showLoading() {
    loading.style.display = 'block';
    eventsSection.style.display = 'none';
    rawSection.style.display = 'none';
    errorState.style.display = 'none';
  }

  function showEvents() {
    loading.style.display = 'none';
    eventsSection.style.display = 'block';
    rawSection.style.display = 'block';
    errorState.style.display = 'none';
    
    // Update raw JSON
    document.getElementById('raw-json').textContent = JSON.stringify(rawData, null, 2);
  }

  function showError(message) {
    loading.style.display = 'none';
    eventsSection.style.display = 'none';
    rawSection.style.display = 'none';
    errorState.style.display = 'block';
    
    document.getElementById('error-message').textContent = message;
  }

  // Process events with the same logic as Laravel
  function processEvents(data) {
    const events = collectEvents(data);
    currentEvents = events;
    renderEventsTable(events);
    
    document.getElementById('events-count').textContent = `${events.length} —Å–æ–±—ã—Ç–∏–π`;
  }

  // Recursive function to collect events like in Laravel
  function collectEvents(obj) {
    const events = [];
    
    function traverse(current) {
      if (!current || typeof current !== 'object') return;
      
      if (Array.isArray(current)) {
        current.forEach(traverse);
        return;
      }
      
      // Check if this object looks like an event
      if ((current.type || current.event_type || current.category) && 
          (current.name || current.body || current.object || current.target)) {
        events.push(normalizeEvent(current));
      }
      
      // Traverse nested objects
      Object.values(current).forEach(traverse);
    }
    
    traverse(obj);
    return events;
  }

  // Normalize event data like in Laravel
  function normalizeEvent(event) {
    return {
      name: event.name || event.body || event.object || event.target || '',
      type: event.type || event.event_type || event.category || event.kind || '',
      when: event.time || event.date || event.occursAt || event.peak || event.instant || '',
      extra: event.magnitude || event.mag || event.altitude || event.note || ''
    };
  }

  function renderEventsTable(events) {
    const tbody = document.getElementById('events-table-body');
    
    if (events.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">—Å–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
      return;
    }
    
    tbody.innerHTML = events.slice(0, 200).map((event, index) => `
      <tr class="border-b border-gray-700 hover:bg-slate-700 hover:bg-opacity-30">
        <td class="py-3 px-3 text-gray-400">${index + 1}</td>
        <td class="py-3 px-3">
          <span class="font-medium text-yellow-400">${event.name || '‚Äî'}</span>
        </td>
        <td class="py-3 px-3 text-gray-300">${event.type || '‚Äî'}</td>
        <td class="py-3 px-3">
          <code class="bg-slate-800 px-2 py-1 rounded text-green-400 text-xs">
            ${event.when || '‚Äî'}
          </code>
        </td>
        <td class="py-3 px-3 text-gray-400">${event.extra || ''}</td>
      </tr>
    `).join('');
  }

  // Export CSV functionality
  document.getElementById('export-events').addEventListener('click', () => {
    if (currentEvents.length === 0) return;
    
    const csv = [
      ['#', '–û–±—ä–µ–∫—Ç', '–°–æ–±—ã—Ç–∏–µ', '–í—Ä–µ–º—è UTC', '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ'],
      ...currentEvents.map((event, index) => [
        index + 1,
        event.name || '',
        event.type || '',
        event.when || '',
        event.extra || ''
      ])
    ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `astro_events_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Global load function
  window.loadEvents = loadEvents;

  // Auto-load on page load with default parameters
  loadEvents();
});
</script>
