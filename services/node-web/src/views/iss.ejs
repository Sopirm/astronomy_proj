<!-- ISS Tracking Page -->
<% 
// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
const issData = last?.payload || {};
const trendData = trend?.points || [];
%>

<div class="animate__animated animate__fadeIn">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">
      üõ∏ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –°—Ç–∞–Ω—Ü–∏—è
    </h1>
    <p class="text-gray-400 mt-2">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ú–ö–° –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
  </div>

  <!-- Current Status Cards -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="space-card rounded-lg p-4 text-center animate__animated animate__fadeInUp">
      <div class="text-blue-400 text-2xl mb-2">üåç</div>
      <div class="text-sm text-gray-400">–®–∏—Ä–æ—Ç–∞</div>
      <div class="text-xl font-bold text-blue-400">
        <%= issData.latitude ? issData.latitude.toFixed(4) + '¬∞' : '‚Äî' %>
      </div>
    </div>

    <div class="space-card rounded-lg p-4 text-center animate__animated animate__fadeInUp" style="animation-delay: 0.1s">
      <div class="text-green-400 text-2xl mb-2">üåè</div>
      <div class="text-sm text-gray-400">–î–æ–ª–≥–æ—Ç–∞</div>
      <div class="text-xl font-bold text-green-400">
        <%= issData.longitude ? issData.longitude.toFixed(4) + '¬∞' : '‚Äî' %>
      </div>
    </div>

    <div class="space-card rounded-lg p-4 text-center animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
      <div class="text-purple-400 text-2xl mb-2">üöÄ</div>
      <div class="text-sm text-gray-400">–°–∫–æ—Ä–æ—Å—Ç—å</div>
      <div class="text-xl font-bold text-purple-400">
        <%= issData.velocity ? Math.round(issData.velocity).toLocaleString() + ' –∫–º/—á' : '‚Äî' %>
      </div>
    </div>

    <div class="space-card rounded-lg p-4 text-center animate__animated animate__fadeInUp" style="animation-delay: 0.3s">
      <div class="text-yellow-400 text-2xl mb-2">üì°</div>
      <div class="text-sm text-gray-400">–í—ã—Å–æ—Ç–∞</div>
      <div class="text-xl font-bold text-yellow-400">
        <%= issData.altitude ? Math.round(issData.altitude).toLocaleString() + ' –∫–º' : '‚Äî' %>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <!-- Main Map -->
    <div class="xl:col-span-2 space-card rounded-lg p-6 animate__animated animate__fadeInLeft">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-blue-400">üó∫Ô∏è –¢—Ä–µ–∫–∏–Ω–≥ –ú–ö–°</h3>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span class="text-sm text-gray-400">Live</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
            <span class="text-sm text-gray-400">–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è</span>
          </div>
        </div>
      </div>
      
      <!-- Map Container -->
      <div id="iss-detailed-map" class="rounded-lg border border-blue-500 border-opacity-30" style="height: 500px;"></div>
      
      <div class="mt-4 text-center">
        <p class="text-sm text-gray-400">
          –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 
          <span id="last-update-time" class="text-blue-400">
            <%= issData.timestamp ? new Date(issData.timestamp).toLocaleString('ru-RU') : '‚Äî' %>
          </span>
        </p>
      </div>
    </div>

    <!-- Side Panel -->
    <div class="space-card rounded-lg p-6 animate__animated animate__fadeInRight">
      <!-- Controls -->
      <div class="mb-6">
        <h4 class="text-lg font-semibold text-purple-400 mb-3">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h4>
        <div class="space-y-3">
          <button id="follow-iss" 
                  class="w-full p-3 bg-blue-600 bg-opacity-20 hover:bg-opacity-30 border border-blue-500 rounded-lg text-blue-400 transition-all">
            üìç –°–ª–µ–¥–∏—Ç—å –∑–∞ –ú–ö–°
          </button>
          <button id="show-orbit" 
                  class="w-full p-3 bg-purple-600 bg-opacity-20 hover:bg-opacity-30 border border-purple-500 rounded-lg text-purple-400 transition-all">
            üåå –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ä–±–∏—Ç—É
          </button>
          <button id="clear-trail" 
                  class="w-full p-3 bg-gray-600 bg-opacity-20 hover:bg-opacity-30 border border-gray-500 rounded-lg text-gray-400 transition-all">
            üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å–ª–µ–¥
          </button>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="mb-6">
        <h4 class="text-lg font-semibold text-green-400 mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-400">–ü–µ—Ä–∏–æ–¥ –æ—Ä–±–∏—Ç—ã:</span>
            <span class="text-green-400">~92 –º–∏–Ω</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">–û–±–æ—Ä–æ—Ç–æ–≤ –≤ —Å—É—Ç–∫–∏:</span>
            <span class="text-green-400">~15.5</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">–í–∏–¥–∏–º–æ—Å—Ç—å:</span>
            <span class="text-yellow-400" id="visibility-status">–†–∞—Å—á—ë—Ç...</span>
          </div>
        </div>
      </div>

      <!-- Crew Info -->
      <div>
        <h4 class="text-lg font-semibold text-yellow-400 mb-3">üë®‚ÄçüöÄ –≠–∫–∏–ø–∞–∂</h4>
        <div class="space-y-2 text-sm">
          <div class="p-2 bg-slate-700 bg-opacity-50 rounded">
            <div class="font-medium">–≠–∫—Å–ø–µ–¥–∏—Ü–∏—è #70</div>
            <div class="text-gray-400">7 —á–µ–ª–æ–≤–µ–∫ –Ω–∞ –±–æ—Ä—Ç—É</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Altitude Chart -->
    <div class="space-card rounded-lg p-6 animate__animated animate__fadeInUp">
      <h4 class="text-lg font-semibold text-blue-400 mb-4">üìà –ò—Å—Ç–æ—Ä–∏—è –≤—ã—Å–æ—Ç—ã</h4>
      <canvas id="altitude-history-chart" class="w-full" height="200"></canvas>
    </div>

    <!-- Speed Chart -->
    <div class="space-card rounded-lg p-6 animate__animated animate__fadeInUp" style="animation-delay: 0.1s">
      <h4 class="text-lg font-semibold text-green-400 mb-4">‚ö° –ò—Å—Ç–æ—Ä–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏</h4>
      <canvas id="speed-history-chart" class="w-full" height="200"></canvas>
    </div>
  </div>

  <!-- Data Table -->
  <div class="mt-8 space-card rounded-lg p-6 animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
    <div class="flex items-center justify-between mb-4">
      <h4 class="text-lg font-semibold text-cyan-400">üìã –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∑–∏—Ü–∏–π</h4>
      <div class="flex items-center space-x-4">
        <select id="history-limit" class="bg-slate-700 border border-gray-600 rounded px-3 py-1 text-sm">
          <option value="50">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50</option>
          <option value="100">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100</option>
          <option value="200" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 200</option>
        </select>
        <button id="export-data" 
                class="px-4 py-2 bg-cyan-600 bg-opacity-20 hover:bg-opacity-30 border border-cyan-500 rounded text-cyan-400 text-sm transition-all">
          üì• –≠–∫—Å–ø–æ—Ä—Ç CSV
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-600">
            <th class="text-left py-3 px-2 text-gray-400">–í—Ä–µ–º—è (UTC)</th>
            <th class="text-left py-3 px-2 text-gray-400">–®–∏—Ä–æ—Ç–∞</th>
            <th class="text-left py-3 px-2 text-gray-400">–î–æ–ª–≥–æ—Ç–∞</th>
            <th class="text-left py-3 px-2 text-gray-400">–í—ã—Å–æ—Ç–∞ (–∫–º)</th>
            <th class="text-left py-3 px-2 text-gray-400">–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)</th>
          </tr>
        </thead>
        <tbody id="iss-history-table">
          <tr><td colspan="5" class="text-center py-4 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üõ∏ ISS Page –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

  // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  const initialData = <%- JSON.stringify({ last, trend }) %>;
  let followIss = true;
  let showOrbit = true;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  const map = L.map('iss-detailed-map', { 
    attributionControl: false,
    zoomControl: true,
    worldCopyJump: true
  }).setView([0, 0], 2);

  // Tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
    attribution: '',
    noWrap: false
  }).addTo(map);

  // –ú–ö–° —ç–ª–µ–º–µ–Ω—Ç—ã
  let issMarker, issTrail, orbitLine;
  const trailPoints = [];

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ú–ö–° –Ω–∞ –∫–∞—Ä—Ç–µ
  function initISSOnMap() {
    const issData = initialData.last?.payload;
    if (!issData) return;

    const lat = issData.latitude || 0;
    const lon = issData.longitude || 0;

    // –ö–∞—Å—Ç–æ–º–Ω—ã–π –º–∞—Ä–∫–µ—Ä –ú–ö–°
    const issIcon = L.divIcon({
      className: 'custom-iss-marker',
      html: '<div style="font-size: 24px;">üõ∏</div>',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    issMarker = L.marker([lat, lon], { icon: issIcon }).addTo(map);
    issMarker.bindPopup(`
      <div class="text-center">
        <strong>–ú–ö–°</strong><br>
        –®–∏—Ä–æ—Ç–∞: ${lat.toFixed(4)}¬∞<br>
        –î–æ–ª–≥–æ—Ç–∞: ${lon.toFixed(4)}¬∞<br>
        –í—ã—Å–æ—Ç–∞: ${Math.round(issData.altitude || 0)} –∫–º<br>
        –°–∫–æ—Ä–æ—Å—Ç—å: ${Math.round(issData.velocity || 0)} –∫–º/—á
      </div>
    `);

    // –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è
    issTrail = L.polyline([], { 
      color: '#3b82f6', 
      weight: 3,
      opacity: 0.7 
    }).addTo(map);

    if (followIss) {
      map.setView([lat, lon], 4);
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
  function initCharts() {
    const altCtx = document.getElementById('altitude-history-chart');
    const speedCtx = document.getElementById('speed-history-chart');

    window.altChart = new Chart(altCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '–í—ã—Å–æ—Ç–∞ (–∫–º)',
          data: [],
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e2e8f0' }
          }
        },
        scales: {
          x: { 
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          },
          y: { 
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          }
        }
      }
    });

    window.speedChart = new Chart(speedCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)',
          data: [],
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e2e8f0' }
          }
        },
        scales: {
          x: { 
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          },
          y: { 
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          }
        }
      }
    });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
  async function loadTrendData() {
    try {
      const response = await fetch('/api/iss/trend?limit=200');
      const data = await response.json();
      const points = data.points || [];

      updateCharts(points);
      updateTable(points);
      updateTrail(points);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤:', error);
    }
  }

  function updateCharts(points) {
    const labels = points.map(p => new Date(p.at).toLocaleTimeString());
    const altitudes = points.map(p => p.altitude);
    const velocities = points.map(p => p.velocity);

    window.altChart.data.labels = labels;
    window.altChart.data.datasets[0].data = altitudes;
    window.altChart.update('none');

    window.speedChart.data.labels = labels;
    window.speedChart.data.datasets[0].data = velocities;
    window.speedChart.update('none');
  }

  function updateTable(points) {
    const tbody = document.getElementById('iss-history-table');
    tbody.innerHTML = points.slice(0, 50).map(p => `
      <tr class="border-b border-gray-700 hover:bg-slate-700 hover:bg-opacity-30">
        <td class="py-2 px-2">${new Date(p.at).toLocaleString('ru-RU')}</td>
        <td class="py-2 px-2">${p.lat.toFixed(4)}¬∞</td>
        <td class="py-2 px-2">${p.lon.toFixed(4)}¬∞</td>
        <td class="py-2 px-2">${Math.round(p.altitude)}</td>
        <td class="py-2 px-2">${Math.round(p.velocity)}</td>
      </tr>
    `).join('');
  }

  function updateTrail(points) {
    const coords = points.map(p => [p.lat, p.lon]);
    issTrail.setLatLngs(coords);
  }

  // Event listeners –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  document.getElementById('follow-iss').addEventListener('click', () => {
    followIss = !followIss;
    const btn = document.getElementById('follow-iss');
    if (followIss) {
      btn.textContent = 'üìç –°–ª–µ–∂–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ';
      btn.classList.add('bg-green-600');
      btn.classList.remove('bg-blue-600');
    } else {
      btn.textContent = 'üìç –°–ª–µ–¥–∏—Ç—å –∑–∞ –ú–ö–°';
      btn.classList.add('bg-blue-600');
      btn.classList.remove('bg-green-600');
    }
  });

  document.getElementById('show-orbit').addEventListener('click', () => {
    showOrbit = !showOrbit;
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑ –æ—Ä–±–∏—Ç—ã
  });

  document.getElementById('clear-trail').addEventListener('click', () => {
    issTrail.setLatLngs([]);
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  initISSOnMap();
  initCharts();
  loadTrendData();

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
  setInterval(async () => {
    try {
      const response = await fetch('/api/iss/last');
      const data = await response.json();
      
      if (data.payload) {
        const lat = data.payload.latitude;
        const lon = data.payload.longitude;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
        issMarker.setLatLng([lat, lon]);
        
        if (followIss) {
          map.setView([lat, lon], map.getZoom());
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        document.getElementById('last-update-time').textContent = 
          new Date().toLocaleString('ru-RU');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ú–ö–°:', error);
    }
  }, 15000);
});
</script>

<style>
.custom-iss-marker {
  background: none !important;
  border: none !important;
}

.custom-iss-marker div {
  text-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
  animation: pulse-iss 2s infinite;
}

@keyframes pulse-iss {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
</style>
