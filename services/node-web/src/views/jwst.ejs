<!-- JWST Gallery Page -->
<div class="animate__animated animate__fadeIn">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
      üî≠ James Webb Space Telescope
    </h1>
    <p class="text-gray-400 mt-2">–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–∞–º–æ–≥–æ –º–æ—â–Ω–æ–≥–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–ª–µ—Å–∫–æ–ø–∞</p>
  </div>

  <!-- Advanced Filters -->
  <div class="space-card rounded-lg p-6 mb-6 animate__animated animate__fadeInDown">
    <form id="jwst-filters" class="space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-purple-400">üéõÔ∏è –§–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="flex items-center space-x-3">
          <div class="text-sm text-gray-400">
            –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="images-count" class="text-purple-400 font-semibold">0</span> –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          </div>
          <button type="button" id="reset-filters-btn" 
                  class="px-3 py-1 bg-gray-600 bg-opacity-20 hover:bg-opacity-30 border border-gray-500 rounded text-gray-400 text-sm transition-all">
            üîÑ –°–±—Ä–æ—Å
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Source Type -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞</label>
          <select name="source" id="source-select" class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
            <option value="jpg" selected>üì∏ –í—Å–µ JPG</option>
            <option value="suffix">üè∑Ô∏è –ü–æ —Å—É—Ñ—Ñ–∏–∫—Å—É</option>
            <option value="program">üöÄ –ü–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ</option>
          </select>
        </div>

        <!-- Suffix Filter -->
        <div id="suffix-filter" style="display: none;">
          <label class="block text-sm font-medium text-gray-400 mb-2">–°—É—Ñ—Ñ–∏–∫—Å</label>
          <input type="text" name="suffix" id="suffix-input" 
                 placeholder="_cal, _thumb, _crf" 
                 class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
        </div>

        <!-- Program Filter -->
        <div id="program-filter" style="display: none;">
          <label class="block text-sm font-medium text-gray-400 mb-2">ID –ø—Ä–æ–≥—Ä–∞–º–º—ã</label>
          <input type="text" name="program" id="program-input" 
                 placeholder="2734, 1345" 
                 class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
        </div>

        <!-- Instrument Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
          <select name="instrument" class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
            <option value="">üî≠ –õ—é–±–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</option>
            <option value="NIRCam">üì∑ NIRCam</option>
            <option value="MIRI">üå°Ô∏è MIRI</option>
            <option value="NIRISS">üî¨ NIRISS</option>
            <option value="NIRSpec">üìä NIRSpec</option>
            <option value="FGS">üéØ FGS</option>
          </select>
        </div>

        <!-- Items per page -->
        <div>
          <label class="block text-sm font-medium text-gray-400 mb-2">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
          <select name="perPage" class="w-full bg-slate-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
            <option value="12">12 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</option>
            <option value="24" selected>24 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</option>
            <option value="36">36 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</option>
            <option value="48">48 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</option>
          </select>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center justify-between pt-4 border-t border-gray-600">
        <div class="flex items-center space-x-3">
          <button type="submit" 
                  class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
            üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
          </button>
          
          <button type="button" id="random-images-btn"
                  class="px-4 py-2 bg-pink-600 bg-opacity-20 hover:bg-opacity-30 border border-pink-500 rounded-lg text-pink-400 transition-all">
            üé≤ –°–ª—É—á–∞–π–Ω—ã–µ
          </button>
        </div>

        <!-- View Options -->
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-400">–í–∏–¥:</span>
          <div class="flex bg-slate-700 rounded-lg p-1">
            <button type="button" id="grid-view" class="px-3 py-1 rounded text-sm bg-purple-600 text-white transition-all">
              üî≤ –°–µ—Ç–∫–∞
            </button>
            <button type="button" id="list-view" class="px-3 py-1 rounded text-sm text-gray-400 hover:text-white transition-all">
              üìã –°–ø–∏—Å–æ–∫
            </button>
            <button type="button" id="slideshow-view" class="px-3 py-1 rounded text-sm text-gray-400 hover:text-white transition-all">
              üé¨ –°–ª–∞–π–¥—à–æ—É
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Loading State -->
  <div id="loading-state" class="text-center py-12 space-card rounded-lg">
    <div class="loading text-purple-400 text-4xl mb-4">üî≠</div>
    <h3 class="text-lg font-semibold text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π JWST...</h3>
    <p class="text-gray-500 mt-2">–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç —Ç–µ–ª–µ—Å–∫–æ–ø–∞</p>
  </div>

  <!-- Grid View -->
  <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" style="display: none;">
    <!-- Images will be loaded here -->
  </div>

  <!-- List View -->
  <div id="gallery-list" class="space-y-4" style="display: none;">
    <!-- List items will be loaded here -->
  </div>

  <!-- Slideshow View -->
  <div id="slideshow-container" class="space-card rounded-lg p-6" style="display: none;">
    <div class="text-center">
      <div class="relative">
        <img id="slideshow-image" class="mx-auto rounded-lg max-h-96 object-contain" alt="JWST Image">
        <div class="absolute inset-0 flex items-center justify-between p-4">
          <button id="prev-slide" class="p-2 bg-black bg-opacity-50 rounded-full text-white hover:bg-opacity-75">
            ‚Äπ
          </button>
          <button id="next-slide" class="p-2 bg-black bg-opacity-50 rounded-full text-white hover:bg-opacity-75">
            ‚Ä∫
          </button>
        </div>
      </div>
      <div id="slideshow-caption" class="mt-4 text-lg font-semibold text-purple-400"></div>
      <div id="slideshow-controls" class="mt-4 flex items-center justify-center space-x-4">
        <button id="play-pause" class="px-4 py-2 bg-purple-600 bg-opacity-20 hover:bg-opacity-30 border border-purple-500 rounded text-purple-400">
          ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
        </button>
        <span class="text-gray-400">
          <span id="current-slide">1</span> / <span id="total-slides">0</span>
        </span>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="text-center py-12 space-card rounded-lg" style="display: none;">
    <div class="text-6xl mb-4">üî≠</div>
    <h3 class="text-xl font-semibold text-gray-400 mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤</p>
    <button class="mt-4 px-4 py-2 bg-purple-600 bg-opacity-20 hover:bg-opacity-30 border border-purple-500 rounded text-purple-400 transition-all"
            onclick="resetFilters()">
      üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
    </button>
  </div>

  <!-- Pagination -->
  <div id="pagination" class="flex items-center justify-center space-x-2 mt-8" style="display: none;">
    <button id="prev-page" class="px-4 py-2 bg-slate-700 border border-gray-600 rounded text-gray-400 hover:text-white disabled:opacity-50">
      ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
    </button>
    <div id="page-info" class="px-4 py-2 text-gray-400">
      –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span id="current-page">1</span> –∏–∑ <span id="total-pages">1</span>
    </div>
    <button id="next-page" class="px-4 py-2 bg-slate-700 border border-gray-600 rounded text-gray-400 hover:text-white disabled:opacity-50">
      –°–ª–µ–¥—É—é—â–∞—è ‚Üí
    </button>
  </div>
</div>

<!-- Fullscreen Modal -->
<div id="fullscreen-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50" style="display: none;">
  <div class="relative w-full h-full flex items-center justify-center p-4">
    <img id="fullscreen-image" class="max-w-full max-h-full object-contain rounded-lg">
    
    <!-- Navigation -->
    <button id="fs-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-3 bg-black bg-opacity-50 rounded-full text-white hover:bg-opacity-75">
      ‚Äπ
    </button>
    <button id="fs-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 p-3 bg-black bg-opacity-50 rounded-full text-white hover:bg-opacity-75">
      ‚Ä∫
    </button>
    
    <!-- Close Button -->
    <button id="fs-close" class="absolute top-4 right-4 p-3 bg-black bg-opacity-50 rounded-full text-white hover:bg-opacity-75 text-2xl">
      ‚úï
    </button>
    
    <!-- Image Info -->
    <div class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 rounded-lg p-4 text-white">
      <h4 id="fs-title" class="font-semibold text-lg mb-2"></h4>
      <div class="flex items-center justify-between text-sm text-gray-300">
        <span id="fs-details"></span>
        <div class="space-x-2">
          <button id="fs-download" class="px-3 py-1 bg-purple-600 bg-opacity-20 hover:bg-opacity-30 rounded text-purple-400">
            üì• –°–∫–∞—á–∞—Ç—å
          </button>
          <button id="fs-share" class="px-3 py-1 bg-blue-600 bg-opacity-20 hover:bg-opacity-30 rounded text-blue-400">
            üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('üî≠ JWST Page –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

  // State
  let currentImages = [];
  let currentView = 'grid';
  let currentPage = 1;
  let slideshowTimer = null;
  let slideshowIndex = 0;
  let isPlaying = false;

  // Elements
  const form = document.getElementById('jwst-filters');
  const sourceSelect = document.getElementById('source-select');
  const suffixFilter = document.getElementById('suffix-filter');
  const programFilter = document.getElementById('program-filter');
  const loadingState = document.getElementById('loading-state');
  const galleryGrid = document.getElementById('gallery-grid');
  const galleryList = document.getElementById('gallery-list');
  const slideshowContainer = document.getElementById('slideshow-container');
  const emptyState = document.getElementById('empty-state');

  // Toggle filter inputs based on source type
  sourceSelect.addEventListener('change', () => {
    const value = sourceSelect.value;
    suffixFilter.style.display = value === 'suffix' ? 'block' : 'none';
    programFilter.style.display = value === 'program' ? 'block' : 'none';
  });

  // Load images function
  async function loadImages(params = {}) {
    showLoading();
    
    try {
      const formData = new FormData(form);
      const queryParams = new URLSearchParams();
      
      for (const [key, value] of formData.entries()) {
        if (value) queryParams.append(key, value);
      }
      
      // Add custom params
      Object.entries(params).forEach(([key, value]) => {
        if (value) queryParams.set(key, value);
      });

      const response = await fetch(`/api/jwst/feed?${queryParams.toString()}`);
      const data = await response.json();
      
      currentImages = data.items || [];
      
      document.getElementById('images-count').textContent = currentImages.length;
      
      if (currentImages.length === 0) {
        showEmpty();
      } else {
        renderCurrentView();
      }
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JWST –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
      showEmpty();
    }
  }

  function showLoading() {
    loadingState.style.display = 'block';
    galleryGrid.style.display = 'none';
    galleryList.style.display = 'none';
    slideshowContainer.style.display = 'none';
    emptyState.style.display = 'none';
  }

  function showEmpty() {
    loadingState.style.display = 'none';
    galleryGrid.style.display = 'none';
    galleryList.style.display = 'none';
    slideshowContainer.style.display = 'none';
    emptyState.style.display = 'block';
  }

  function renderCurrentView() {
    loadingState.style.display = 'none';
    emptyState.style.display = 'none';
    
    if (currentView === 'grid') {
      renderGrid();
    } else if (currentView === 'list') {
      renderList();
    } else if (currentView === 'slideshow') {
      renderSlideshow();
    }
  }

  function renderGrid() {
    galleryGrid.style.display = 'grid';
    galleryList.style.display = 'none';
    slideshowContainer.style.display = 'none';
    
    galleryGrid.innerHTML = currentImages.map((item, index) => `
      <div class="space-card rounded-lg overflow-hidden animate__animated animate__fadeInUp hover:scale-105 transition-transform cursor-pointer"
           style="animation-delay: ${index * 0.05}s"
           onclick="openFullscreen(${index})">
        <div class="aspect-square overflow-hidden">
          <img src="${item.url}" 
               alt="${item.caption}"
               class="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
               loading="lazy">
        </div>
        <div class="p-4">
          <h4 class="text-sm font-semibold text-purple-400 mb-2 line-clamp-2">
            ${item.obs || 'JWST Image'}
          </h4>
          <div class="text-xs text-gray-400 space-y-1">
            ${item.program ? `<div>Program: ${item.program}</div>` : ''}
            ${item.inst.length ? `<div>Instruments: ${item.inst.join(', ')}</div>` : ''}
            ${item.suffix ? `<div>Suffix: ${item.suffix}</div>` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderList() {
    galleryGrid.style.display = 'none';
    galleryList.style.display = 'block';
    slideshowContainer.style.display = 'none';
    
    galleryList.innerHTML = currentImages.map((item, index) => `
      <div class="space-card rounded-lg p-4 flex items-center space-x-4 animate__animated animate__fadeInUp hover:bg-opacity-80 transition-all cursor-pointer"
           style="animation-delay: ${index * 0.02}s"
           onclick="openFullscreen(${index})">
        <img src="${item.url}" 
             alt="${item.caption}"
             class="w-20 h-20 object-cover rounded-lg flex-shrink-0"
             loading="lazy">
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-purple-400 mb-1">
            ${item.obs || 'JWST Image'}
          </h4>
          <div class="text-sm text-gray-400 space-y-1">
            ${item.program ? `<div>Program: ${item.program}</div>` : ''}
            ${item.inst.length ? `<div>Instruments: ${item.inst.join(', ')}</div>` : ''}
            ${item.suffix ? `<div>Suffix: ${item.suffix}</div>` : ''}
          </div>
        </div>
        <div class="flex-shrink-0">
          <button class="px-3 py-2 bg-purple-600 bg-opacity-20 hover:bg-opacity-30 border border-purple-500 rounded text-purple-400 transition-all">
            üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
          </button>
        </div>
      </div>
    `).join('');
  }

  function renderSlideshow() {
    if (currentImages.length === 0) return;
    
    galleryGrid.style.display = 'none';
    galleryList.style.display = 'none';
    slideshowContainer.style.display = 'block';
    
    slideshowIndex = 0;
    updateSlideshow();
    
    document.getElementById('total-slides').textContent = currentImages.length;
  }

  function updateSlideshow() {
    if (currentImages.length === 0) return;
    
    const image = currentImages[slideshowIndex];
    document.getElementById('slideshow-image').src = image.url;
    document.getElementById('slideshow-caption').textContent = image.caption || image.obs || 'JWST Image';
    document.getElementById('current-slide').textContent = slideshowIndex + 1;
  }

  // View switching
  document.getElementById('grid-view').addEventListener('click', () => switchView('grid'));
  document.getElementById('list-view').addEventListener('click', () => switchView('list'));
  document.getElementById('slideshow-view').addEventListener('click', () => switchView('slideshow'));

  function switchView(view) {
    currentView = view;
    
    // Update button states
    document.querySelectorAll('[id$="-view"]').forEach(btn => {
      btn.classList.remove('bg-purple-600', 'text-white');
      btn.classList.add('text-gray-400');
    });
    
    document.getElementById(view + '-view').classList.add('bg-purple-600', 'text-white');
    document.getElementById(view + '-view').classList.remove('text-gray-400');
    
    renderCurrentView();
  }

  // Form submission
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    loadImages();
  });

  // Reset filters
  document.getElementById('reset-filters-btn').addEventListener('click', () => {
    form.reset();
    sourceSelect.dispatchEvent(new Event('change'));
    loadImages();
  });

  // Random images
  document.getElementById('random-images-btn').addEventListener('click', () => {
    loadImages({ source: 'jpg', perPage: 24, page: Math.floor(Math.random() * 10) + 1 });
  });

  // Slideshow controls
  document.getElementById('prev-slide').addEventListener('click', () => {
    slideshowIndex = (slideshowIndex - 1 + currentImages.length) % currentImages.length;
    updateSlideshow();
  });

  document.getElementById('next-slide').addEventListener('click', () => {
    slideshowIndex = (slideshowIndex + 1) % currentImages.length;
    updateSlideshow();
  });

  document.getElementById('play-pause').addEventListener('click', () => {
    if (isPlaying) {
      clearInterval(slideshowTimer);
      document.getElementById('play-pause').innerHTML = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
    } else {
      slideshowTimer = setInterval(() => {
        slideshowIndex = (slideshowIndex + 1) % currentImages.length;
        updateSlideshow();
      }, 3000);
      document.getElementById('play-pause').innerHTML = '‚è∏Ô∏è –ü–∞—É–∑–∞';
    }
    isPlaying = !isPlaying;
  });

  // Fullscreen modal
  window.openFullscreen = function(index) {
    const modal = document.getElementById('fullscreen-modal');
    const image = currentImages[index];
    
    document.getElementById('fullscreen-image').src = image.url;
    document.getElementById('fs-title').textContent = image.obs || 'JWST Image';
    document.getElementById('fs-details').textContent = image.caption || '';
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Store current index for navigation
    modal.dataset.currentIndex = index;
  };

  document.getElementById('fs-close').addEventListener('click', () => {
    const modal = document.getElementById('fullscreen-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  });

  // Download functionality
  document.getElementById('fs-download').addEventListener('click', () => {
    const modal = document.getElementById('fullscreen-modal');
    const index = parseInt(modal.dataset.currentIndex);
    const image = currentImages[index];
    
    const a = document.createElement('a');
    a.href = image.url;
    a.download = `jwst_${image.obs || 'image'}.jpg`;
    a.click();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('fullscreen-modal');
    if (modal.style.display === 'flex') {
      if (e.key === 'Escape') {
        document.getElementById('fs-close').click();
      } else if (e.key === 'ArrowLeft') {
        // Previous image
      } else if (e.key === 'ArrowRight') {
        // Next image
      }
    }
  });

  // Global reset function
  window.resetFilters = function() {
    document.getElementById('reset-filters-btn').click();
  };

  // Initial load
  loadImages();
});
</script>

<style>
.aspect-square {
  aspect-ratio: 1 / 1;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
