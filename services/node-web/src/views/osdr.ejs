<% layout('layout') %>
<!-- OSDR Experiments Page -->
<div>
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-900">
      üß™ OSDR - –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
    </h1>
    <p class="text-gray-600 mt-2">Open Science Data Repository - –Ω–∞—É—á–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –≤ –∫–æ—Å–º–æ—Å–µ</p>
  </div>

  <!-- Filter & Search Panel -->
  <div class="space-card rounded-lg p-6 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center space-x-4">
        <h3 class="text-lg font-semibold text-gray-900">üîç –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h3>
      </div>
      
      <div class="flex flex-wrap items-center gap-3">
        <!-- Search Input -->
        <div class="relative">
          <input type="text" 
                 id="search-input" 
                 placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, ID..." 
                 class="bg-white border border-gray-300 rounded-lg px-4 py-2 pl-10 text-sm w-64 focus:border-blue-500 focus:outline-none text-gray-900">
          <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            üîç
          </div>
        </div>

        <!-- Status Filter -->
        <select id="status-filter" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:outline-none">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="completed">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</option>
          <option value="pending">–û–∂–∏–¥–∞—é—â–∏–µ</option>
        </select>

        <!-- Sort Options -->
        <select id="sort-options" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:outline-none">
          <option value="updated_at_desc">–ü–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üì</option>
          <option value="updated_at_asc">–ü–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Üë</option>
          <option value="title_asc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üë</option>
          <option value="title_desc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üì</option>
          <option value="id_asc">–ü–æ ID ‚Üë</option>
          <option value="id_desc">–ü–æ ID ‚Üì</option>
        </select>

        <!-- View Toggle -->
        <div class="flex bg-gray-100 rounded-lg p-1">
          <button id="view-cards" class="px-3 py-1 rounded text-sm text-gray-700 hover:text-gray-900 transition-colors">
            üìã –ö–∞—Ä—Ç–æ—á–∫–∏
          </button>
          <button id="view-table" class="px-3 py-1 rounded text-sm text-gray-700 hover:text-gray-900 transition-colors">
            üìä –¢–∞–±–ª–∏—Ü–∞  
          </button>
        </div>

        <!-- Export Button -->
        <button id="export-btn" 
                class="px-4 py-2 bg-green-100 hover:bg-green-200 border border-green-300 rounded-lg text-green-700 text-sm transition-colors">
          üì• –≠–∫—Å–ø–æ—Ä—Ç CSV
        </button>
      </div>
    </div>

    <!-- Filter Summary -->
    <div class="mt-4 pt-4 border-t border-gray-200">
      <div class="flex items-center justify-between text-sm">
        <div class="text-gray-600">
          –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="filtered-count" class="text-blue-600 font-semibold"><%= items.length %></span> –∏–∑ 
          <span id="total-count" class="text-gray-900 font-semibold"><%= items.length %></span> —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
        </div>
        <div class="flex items-center space-x-4">
          <button id="reset-filters" class="text-gray-600 hover:text-gray-900 transition-colors">
            üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cards View -->
  <div id="cards-view">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="experiments-grid">
      <% items.forEach((item, index) => { %>
      <div class="experiment-card space-card rounded-lg p-5" 
           data-item='<%- JSON.stringify(item) %>'>
        
        <!-- Experiment Header -->
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-900 mb-1 line-clamp-2">
              <%= item.title || `–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç ${item.dataset_id || item.id}` %>
            </h4>
            <div class="text-sm text-gray-600">
              ID: <span class="text-gray-800 font-mono"><%= item.dataset_id || item.id %></span>
            </div>
          </div>
          
          <div class="ml-3">
            <% if (item.status) { %>
            <span class="px-2 py-1 text-xs rounded-full
              <%= item.status === 'active' ? 'bg-green-100 text-green-700 border border-green-300' : 
                  item.status === 'completed' ? 'bg-blue-100 text-blue-700 border border-blue-300' :
                  'bg-yellow-100 text-yellow-700 border border-yellow-300' %>">
              <%= item.status %>
            </span>
            <% } %>
          </div>
        </div>

        <!-- Experiment Details -->
        <div class="space-y-2 text-sm">
          <% if (item.updated_at) { %>
          <div class="flex justify-between">
            <span class="text-gray-600">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
            <span class="text-gray-800"><%= new Date(item.updated_at).toLocaleDateString('ru-RU') %></span>
          </div>
          <% } %>
          
          <% if (item.inserted_at) { %>
          <div class="flex justify-between">
            <span class="text-gray-600">–°–æ–∑–¥–∞–Ω–æ:</span>
            <span class="text-gray-800"><%= new Date(item.inserted_at).toLocaleDateString('ru-RU') %></span>
          </div>
          <% } %>

          <% if (item.rest_url) { %>
          <div class="flex justify-between">
            <span class="text-gray-600">API:</span>
            <a href="<%= item.rest_url %>" target="_blank" 
               class="text-blue-600 hover:text-blue-800 text-xs font-mono transition-colors">
              üîó REST API
            </a>
          </div>
          <% } %>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <div class="flex space-x-2">
            <button class="flex-1 px-3 py-2 bg-blue-100 hover:bg-blue-200 border border-blue-300 rounded text-blue-700 text-sm transition-colors"
                    onclick="viewDetails('<%= item.id %>')">
              üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
            </button>
            <% if (item.rest_url) { %>
            <button class="px-3 py-2 bg-blue-100 hover:bg-blue-200 border border-blue-300 rounded text-blue-700 text-sm transition-colors"
                    onclick="window.open('<%= item.rest_url %>', '_blank')">
              üîó API
            </button>
            <% } %>
          </div>
        </div>
      </div>
      <% }); %>
    </div>
  </div>

  <!-- Table View -->
  <div id="table-view" style="display: none;">
    <div class="space-card rounded-lg p-6">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-3 px-3 text-gray-700 cursor-pointer hover:text-gray-900" data-sort="id">
                ID <span class="sort-indicator">‚ÜïÔ∏è</span>
              </th>
              <th class="text-left py-3 px-3 text-gray-700 cursor-pointer hover:text-gray-900" data-sort="title">
                –ù–∞–∑–≤–∞–Ω–∏–µ <span class="sort-indicator">‚ÜïÔ∏è</span>
              </th>
              <th class="text-left py-3 px-3 text-gray-700 cursor-pointer hover:text-gray-900" data-sort="status">
                –°—Ç–∞—Ç—É—Å <span class="sort-indicator">‚ÜïÔ∏è</span>
              </th>
              <th class="text-left py-3 px-3 text-gray-700 cursor-pointer hover:text-gray-900" data-sort="updated_at">
                –û–±–Ω–æ–≤–ª–µ–Ω–æ <span class="sort-indicator">‚ÜïÔ∏è</span>
              </th>
              <th class="text-left py-3 px-3 text-gray-700">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="experiments-table-body">
            <% items.forEach(item => { %>
            <tr class="border-b border-gray-200 hover:bg-gray-100 experiment-row" 
                data-item='<%- JSON.stringify(item) %>'>
              <td class="py-3 px-3">
                <span class="font-mono text-gray-800"><%= item.dataset_id || item.id %></span>
              </td>
              <td class="py-3 px-3">
                <div class="max-w-xs">
                  <div class="font-medium text-gray-900 truncate">
                    <%= item.title || `–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç ${item.dataset_id || item.id}` %>
                  </div>
                </div>
              </td>
              <td class="py-3 px-3">
                <% if (item.status) { %>
                <span class="px-2 py-1 text-xs rounded-full
                  <%= item.status === 'active' ? 'bg-green-100 text-green-700 border border-green-300' : 
                      item.status === 'completed' ? 'bg-blue-100 text-blue-700 border border-blue-300' :
                      'bg-yellow-100 text-yellow-700 border border-yellow-300' %>">
                  <%= item.status %>
                </span>
                <% } else { %>
                <span class="text-gray-500">‚Äî</span>
                <% } %>
              </td>
              <td class="py-3 px-3 text-gray-700">
                <%= item.updated_at ? new Date(item.updated_at).toLocaleDateString('ru-RU') : '‚Äî' %>
              </td>
              <td class="py-3 px-3">
                <div class="flex space-x-1">
                  <button class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-blue-700 text-xs transition-colors"
                          onclick="viewDetails('<%= item.id %>')">
                    üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–æ
                  </button>
                  <% if (item.rest_url) { %>
                  <button class="px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-blue-700 text-xs transition-colors"
                          onclick="window.open('<%= item.rest_url %>', '_blank')">
                    üîó API
                  </button>
                  <% } %>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="text-center py-12 space-card rounded-lg" style="display: none;">
    <div class="text-6xl mb-4 text-gray-500">üîç</div>
    <h3 class="text-xl font-semibold text-gray-900 mb-2">–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p class="text-gray-600">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
    <button class="mt-4 px-4 py-2 bg-blue-100 hover:bg-blue-200 border border-blue-300 rounded text-blue-700 transition-colors"
            onclick="resetFilters()">
      üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
    </button>
  </div>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
  <div class="space-card rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold text-gray-900">üî¨ –î–µ—Ç–∞–ª–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞</h3>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
    </div>
    <div id="modal-content"></div>
  </div>
</div>

<div id="server-osdr-items" style="display:none;"><%- JSON.stringify(items || []) %></div>
<script src="/js/osdr-page.js" defer></script>
